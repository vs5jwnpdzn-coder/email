<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>

  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(229,57,53,0.18), transparent 60%),
        radial-gradient(1200px 600px at 80% 0%, rgba(30,136,229,0.22), transparent 55%),
        linear-gradient(135deg, #f7f9fc, #eef3fb);
      color: #111;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.8);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .who {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #222;
      flex-wrap: wrap;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 13px;
      white-space: nowrap;
    }

    .adminTag {
      background: rgba(229,57,53,0.10);
      border: 1px solid rgba(229,57,53,0.22);
      color: #b71c1c;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .username { font-weight: 700; }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: white;
      transition: opacity 0.12s ease;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-back { background: #1e88e5; }
    .btn-logout { background: #e53935; }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 46px;
      display: grid;
      grid-template-columns: 460px 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 20px 45px rgba(0,0,0,0.10);
      padding: 16px;
    }

    h1 { margin: 0 0 10px 0; font-size: 18px; color: #111; }
    .hint { margin: 0 0 12px 0; color: #666; font-size: 13px; line-height: 1.45; }

    .tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .tab {
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(0,0,0,0.03);
      cursor: pointer;
      font-size: 13px;
    }
    .tab.active {
      background: rgba(30,136,229,0.12);
      border-color: rgba(30,136,229,0.25);
      font-weight: 800;
    }

    .controls { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }

    input[type="text"]{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.16);
      background: white;
      font-size: 14px;
      outline: none;
    }
    input[type="text"]:focus {
      border-color: rgba(30,136,229,0.6);
      box-shadow: 0 0 0 4px rgba(30,136,229,0.12);
    }

    select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.16);
      background: white;
      font-size: 14px;
      outline: none;
    }

    .btnGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-load { background: linear-gradient(135deg, #1e88e5, #43cea2); font-weight: 800; border-radius: 12px; padding: 11px 14px; }
    .btn-clear { background: linear-gradient(135deg, #ff9800, #f57c00); font-weight: 800; border-radius: 12px; padding: 11px 14px; }
    .btn-rename { background: linear-gradient(135deg, #7e57c2, #5e35b1); font-weight: 800; border-radius: 12px; padding: 11px 14px; }
    .btn-delete { background: linear-gradient(135deg, #e53935, #b71c1c); font-weight: 900; border-radius: 12px; padding: 11px 14px; }

    .status { margin-top: 12px; font-size: 13px; min-height: 18px; word-break: break-word; color: #b71c1c; }
    .status.ok { color: #1b5e20; }

    .headerLine {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .count {
      font-size: 13px;
      color: #444;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.06);
      padding: 7px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    ul { list-style: none; padding: 0; margin: 0; }

    li {
      padding: 12px;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      margin-bottom: 10px;
      background: rgba(0,0,0,0.02);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      word-break: break-word;
    }

    .left { min-width: 0; }
    .email { color: #111; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 620px; font-weight: 700; }
    .sub { color: #666; font-size: 12px; margin-top: 4px; }

    .meta { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .time { color: #666; font-size: 12px; white-space: nowrap; }

    .empty {
      padding: 12px;
      background: rgba(0,0,0,0.02);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      color: #444;
      font-size: 13px;
    }

    .hide { display: none; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="who">
        <div class="pill">Angemeldet als <span class="username" id="adminName">Lade…</span></div>
        <div class="pill adminTag">ADMIN</div>
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn btn-back" id="backBtn">Zurück</button>
        <button class="btn btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="card">
      <div class="tabs">
        <div class="tab active" id="tabUsers">User Verwaltung</div>
        <div class="tab" id="tabAll">Alle Emails</div>
      </div>

      <!-- USERS -->
      <div id="usersPanel">
        <h1>User Verwaltung</h1>
        <p class="hint">Suche → User auswählen → Laden / Emails löschen / Umbenennen / User löschen.</p>

        <div class="controls">
          <input id="searchInput" type="text" placeholder="User suchen…" autocomplete="off" />
          <select id="userSelect" disabled>
            <option>Users laden…</option>
          </select>

          <div class="btnGrid">
            <button class="btn btn-load" id="loadBtn" disabled>Laden</button>
            <button class="btn btn-clear" id="clearBtn" disabled>Emails löschen</button>
            <button class="btn btn-rename" id="renameBtn" disabled>Umbenennen</button>
            <button class="btn btn-delete" id="deleteBtn" disabled>User löschen</button>
          </div>
        </div>

        <div id="statusUsers" class="status"></div>
      </div>

      <!-- ALL EMAILS -->
      <div id="allPanel" class="hide">
        <h1>Alle Emails</h1>
        <p class="hint">Hier siehst du alle gespeicherten Emails zusammen – jeweils mit Username.</p>

        <div class="controls">
          <button class="btn btn-load" id="loadAllBtn">Alle laden</button>
        </div>

        <div id="statusAll" class="status"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="headerLine">
        <h1 id="listTitle">Emails</h1>
        <div class="count" id="countPill">Emails: 0</div>
      </div>
      <div id="listBox"></div>
    </div>
  </div>

  <script>
    const adminName = document.getElementById("adminName");

    // tabs
    const tabUsers = document.getElementById("tabUsers");
    const tabAll = document.getElementById("tabAll");
    const usersPanel = document.getElementById("usersPanel");
    const allPanel = document.getElementById("allPanel");

    // users controls
    const userSelect = document.getElementById("userSelect");
    const searchInput = document.getElementById("searchInput");
    const loadBtn = document.getElementById("loadBtn");
    const clearBtn = document.getElementById("clearBtn");
    const renameBtn = document.getElementById("renameBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const statusUsers = document.getElementById("statusUsers");

    // all emails controls
    const loadAllBtn = document.getElementById("loadAllBtn");
    const statusAll = document.getElementById("statusAll");

    // list
    const listTitle = document.getElementById("listTitle");
    const countPill = document.getElementById("countPill");
    const listBox = document.getElementById("listBox");

    let loading = false;
    let allUsers = [];

    function setStatus(el, text, ok=false) {
      el.className = "status" + (ok ? " ok" : "");
      el.textContent = text || "";
    }

    function setLoading(isLoading) {
      loading = isLoading;

      // users panel
      searchInput.disabled = isLoading;
      userSelect.disabled = isLoading;
      const enabledUser = !isLoading && !!userSelect.value;
      loadBtn.disabled = !enabledUser;
      clearBtn.disabled = !enabledUser;
      renameBtn.disabled = !enabledUser;
      deleteBtn.disabled = !enabledUser;

      // all panel
      loadAllBtn.disabled = isLoading;
    }

    function formatTime(ts) {
      if (!ts) return "";
      try { return new Date(ts).toLocaleString("de-DE"); } catch { return ""; }
    }

    function clearList(title="Emails") {
      listTitle.textContent = title;
      countPill.textContent = "Emails: 0";
      listBox.innerHTML = `<div class="empty">Keine Daten geladen.</div>`;
    }

    async function requireAdmin() {
      const res = await fetch("/api/me", { credentials: "include" });
      if (!res.ok) { location.href = "index.html"; return null; }

      const me = await res.json().catch(() => null);
      if (!me || me.role !== "admin") { location.href = "dashboard.html"; return null; }

      adminName.textContent = me.username;
      return me;
    }

    function renderUserOptions(users) {
      userSelect.innerHTML = `<option value="">— auswählen —</option>` + users
        .map(u => `<option value="${u.replace(/"/g, "&quot;")}">${u}</option>`)
        .join("");
    }

    function applySearchFilter() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const filtered = !q ? allUsers : allUsers.filter(u => u.includes(q));
      renderUserOptions(filtered);
      userSelect.value = "";
      setLoading(false);
      clearList("Emails");
      setStatus(statusUsers, filtered.length ? "Gefiltert ✅" : "Keine Treffer.", true);
    }

    async function loadUsers() {
      setStatus(statusUsers, "Lade Users…");
      userSelect.innerHTML = `<option>Users laden…</option>`;
      userSelect.disabled = true;
      setLoading(true);

      const res = await fetch("/api/admin/users", { credentials: "include" });
      if (!res.ok) {
        setLoading(false);
        setStatus(statusUsers, "Konnte Users nicht laden.", false);
        userSelect.innerHTML = `<option>Fehler</option>`;
        return;
      }

      const data = await res.json().catch(() => null);
      allUsers = (data && data.users) ? data.users : [];

      renderUserOptions(allUsers);
      userSelect.disabled = false;

      setLoading(false);
      setStatus(statusUsers, "Users geladen ✅", true);
    }

    function renderEmailsUser(username, emails) {
      listTitle.textContent = "Emails von: " + username;
      countPill.textContent = "Emails: " + (emails?.length || 0);

      if (!emails || emails.length === 0) {
        listBox.innerHTML = `<div class="empty">Keine Emails gespeichert.</div>`;
        return;
      }

      const ul = document.createElement("ul");
      for (const item of emails) {
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.className = "left";

        const email = document.createElement("div");
        email.className = "email";
        email.textContent = item.email;

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = "User: " + username;

        left.appendChild(email);
        left.appendChild(sub);

        const meta = document.createElement("div");
        meta.className = "meta";

        const timeSpan = document.createElement("span");
        timeSpan.className = "time";
        timeSpan.textContent = formatTime(item.ts);

        meta.appendChild(timeSpan);

        li.appendChild(left);
        li.appendChild(meta);
        ul.appendChild(li);
      }

      listBox.innerHTML = "";
      listBox.appendChild(ul);
    }

    async function loadEmailsForUser(username) {
      if (!username) return;

      setLoading(true);
      setStatus(statusUsers, "Lade Emails von " + username + "…");

      try {
        const res = await fetch("/api/admin/emails?username=" + encodeURIComponent(username), {
          credentials: "include"
        });

        if (!res.ok) {
          const text = await res.text();
          setStatus(statusUsers, text || "Konnte Emails nicht laden.", false);
          renderEmailsUser(username, []);
          return;
        }

        const data = await res.json().catch(() => null);
        const emails = (data && data.emails) ? data.emails : [];

        renderEmailsUser(username, emails);
        setStatus(statusUsers, "Emails geladen ✅", true);
      } catch {
        setStatus(statusUsers, "Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    async function clearEmails(username) {
      if (!username) return;
      const ok = confirm(`ALLE EMAILS LÖSCHEN?\n\nUser: ${username}\n\nAccount bleibt bestehen.`);
      if (!ok) return;

      setLoading(true);
      setStatus(statusUsers, "Lösche alle Emails von " + username + "…");

      try {
        const res = await fetch("/api/admin/clear-emails", {
          method: "DELETE",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });

        const text = await res.text();
        if (!res.ok) { setStatus(statusUsers, text || "Emails löschen fehlgeschlagen.", false); return; }

        const data = JSON.parse(text);
        setStatus(statusUsers, `Emails gelöscht ✅ (gelöscht: ${data.deletedEmails ?? 0})`, true);
        await loadEmailsForUser(username);
      } catch {
        setStatus(statusUsers, "Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    async function renameUser(oldUsername) {
      const newUsername = prompt(`User umbenennen:\n\nAlt: ${oldUsername}\n\nNeuer Username (3–20 Zeichen, a-z 0-9 _ -):`);
      if (!newUsername) return;

      const ok = confirm(`Wirklich umbenennen?\n\n${oldUsername}  →  ${newUsername.trim().toLowerCase()}`);
      if (!ok) return;

      setLoading(true);
      setStatus(statusUsers, "Benenne um…");

      try {
        const res = await fetch("/api/admin/user", {
          method: "PATCH",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ oldUsername, newUsername })
        });

        const text = await res.text();
        if (!res.ok) { setStatus(statusUsers, text || "Umbenennen fehlgeschlagen.", false); return; }

        const data = JSON.parse(text);
        setStatus(statusUsers, `Umbenannt ✅ (Emails verschoben: ${data.movedEmails ?? 0})`, true);

        await loadUsers();
        searchInput.value = "";
        userSelect.value = data.newUsername;
        await loadEmailsForUser(data.newUsername);
      } catch {
        setStatus(statusUsers, "Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    async function deleteUser(username) {
      const ok = confirm(`USER KOMPLETT LÖSCHEN?\n\nUser: ${username}\n\nDas löscht Account + alle Emails.\nDiese Aktion ist endgültig.`);
      if (!ok) return;

      setLoading(true);
      setStatus(statusUsers, "Lösche User " + username + "…");

      try {
        const res = await fetch("/api/admin/user", {
          method: "DELETE",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });

        const text = await res.text();
        if (!res.ok) { setStatus(statusUsers, text || "User löschen fehlgeschlagen.", false); return; }

        const data = JSON.parse(text);
        setStatus(statusUsers, `User gelöscht ✅ (Emails gelöscht: ${data.deletedEmails ?? 0})`, true);

        clearList("Emails");
        await loadUsers();
        userSelect.value = "";
      } catch {
        setStatus(statusUsers, "Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    function renderAllEmails(items) {
      listTitle.textContent = "Alle Emails";
      countPill.textContent = "Emails: " + (items?.length || 0);

      if (!items || items.length === 0) {
        listBox.innerHTML = `<div class="empty">Keine Emails gefunden.</div>`;
        return;
      }

      const ul = document.createElement("ul");
      for (const it of items) {
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.className = "left";

        const email = document.createElement("div");
        email.className = "email";
        email.textContent = it.email;

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = "User: " + it.username;

        left.appendChild(email);
        left.appendChild(sub);

        const meta = document.createElement("div");
        meta.className = "meta";

        const timeSpan = document.createElement("span");
        timeSpan.className = "time";
        timeSpan.textContent = formatTime(it.ts);

        meta.appendChild(timeSpan);

        li.appendChild(left);
        li.appendChild(meta);
        ul.appendChild(li);
      }

      listBox.innerHTML = "";
      listBox.appendChild(ul);
    }

    async function loadAllEmails() {
      setLoading(true);
      setStatus(statusAll, "Lade alle Emails…");

      try {
        const res = await fetch("/api/admin/all-emails?limit=1000", { credentials: "include" });
        const text = await res.text();

        if (!res.ok) {
          setStatus(statusAll, text || "Konnte nicht laden.", false);
          renderAllEmails([]);
          return;
        }

        const data = JSON.parse(text);
        setStatus(statusAll, `Geladen ✅ (gesamt: ${data.total ?? 0}, angezeigt: ${(data.emails || []).length})`, true);
        renderAllEmails(data.emails || []);
      } catch {
        setStatus(statusAll, "Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    // Tabs
    function activate(tab) {
      if (tab === "users") {
        tabUsers.classList.add("active");
        tabAll.classList.remove("active");
        usersPanel.classList.remove("hide");
        allPanel.classList.add("hide");
        clearList("Emails");
      } else {
        tabAll.classList.add("active");
        tabUsers.classList.remove("active");
        allPanel.classList.remove("hide");
        usersPanel.classList.add("hide");
        clearList("Alle Emails");
      }
    }

    tabUsers.addEventListener("click", () => activate("users"));
    tabAll.addEventListener("click", () => activate("all"));

    // Events
    userSelect.addEventListener("change", () => {
      const enabled = !!userSelect.value && !loading;
      loadBtn.disabled = !enabled;
      clearBtn.disabled = !enabled;
      renameBtn.disabled = !enabled;
      deleteBtn.disabled = !enabled;
    });

    searchInput.addEventListener("input", () => {
      if (!allUsers.length) return;
      applySearchFilter();
    });

    loadBtn.addEventListener("click", () => loadEmailsForUser(userSelect.value));
    clearBtn.addEventListener("click", () => clearEmails(userSelect.value));
    renameBtn.addEventListener("click", () => renameUser(userSelect.value));
    deleteBtn.addEventListener("click", () => deleteUser(userSelect.value));

    loadAllBtn.addEventListener("click", loadAllEmails);

    document.getElementById("backBtn").addEventListener("click", () => {
      location.href = "dashboard.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/api/logout", { credentials: "include" });
      location.href = "index.html?loggedout=1";
    });

    (async () => {
      const me = await requireAdmin();
      if (!me) return;

      clearList("Emails");
      await loadUsers();
      setStatus(statusUsers, "Bereit ✅", true);
    })();
  </script>
</body>
</html>