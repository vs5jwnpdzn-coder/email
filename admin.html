<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>

  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body {
      margin: 0;
      min-height: 100vh;
      background: #f4f4f4;
      color: #111;
    }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.92);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      backdrop-filter: blur(8px);
    }
    .topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title {
      font-weight: 900;
      letter-spacing: 0.5px;
    }
    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 13px;
      white-space: nowrap;
    }
    .username { font-weight: 800; }

    .btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #fff;
      background: #1e88e5;
    }
    .btn:hover { opacity: 0.92; }
    .btn-danger { background: #e53935; }
    .btn-ghost {
      background: #111;
      color: #fff;
    }

    /* Layout */
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    .card {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      padding: 16px;
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    input, select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.18);
      outline: none;
      font-size: 14px;
      background: #fff;
    }

    input:focus, select:focus {
      border-color: #1e88e5;
      box-shadow: 0 0 0 4px rgba(30,136,229,0.12);
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      min-height: 18px;
      color: #b71c1c;
      word-break: break-word;
    }
    .status.ok { color: #1b5e20; }

    /* Table */
    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid rgba(0,0,0,0.08); }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
      background: #fff;
    }
    th, td {
      padding: 12px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      text-align: left;
      font-size: 14px;
      vertical-align: middle;
      white-space: nowrap;
    }
    th {
      font-size: 12px;
      letter-spacing: 0.3px;
      color: #444;
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { color: #666; font-size: 12px; }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }
    .btn-small {
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
    }
    .btn-copy { background: #111; }
    .btn-del { background: #e53935; }
    .btn-notify { background: #43cea2; color: #111; font-weight: 800; }

    .inline {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .euro {
      width: 90px;
    }

    .empty {
      padding: 12px;
      background: #fafafa;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="left">
        <div class="title">ADMIN</div>
        <div class="pill">Angemeldet als <span class="username" id="adminName">Lade…</span></div>
        <div class="pill" id="totalPill">Emails gesamt: …</div>
      </div>
      <div class="right">
        <button class="btn btn-danger" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="card-head">
        <h1>Alle Emails</h1>

        <div class="controls">
          <input id="qInput" type="text" placeholder="Suche: email oder username…" autocomplete="off" />
          <select id="userFilter">
            <option value="">Alle User</option>
          </select>

          <select id="limitSelect" title="Limit">
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="1000" selected>1000</option>
            <option value="2000">2000</option>
            <option value="5000">5000</option>
          </select>

          <button class="btn btn-ghost" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="table-wrap" id="tableWrap"></div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    const adminName = document.getElementById("adminName");
    const totalPill = document.getElementById("totalPill");
    const statusEl = document.getElementById("status");
    const tableWrap = document.getElementById("tableWrap");

    const qInput = document.getElementById("qInput");
    const userFilter = document.getElementById("userFilter");
    const limitSelect = document.getElementById("limitSelect");

    let allRows = [];   // {username,email,ts}
    let users = [];

    function setStatus(text, ok=false) {
      statusEl.className = "status" + (ok ? " ok" : "");
      statusEl.textContent = text || "";
    }

    function fmtTime(ts) {
      if (!ts) return "";
      try { return new Date(ts).toLocaleString("de-DE"); } catch { return ""; }
    }

    async function requireAdmin() {
      const res = await fetch("/api/me?t=" + Date.now(), { credentials: "include", cache: "no-store" });
      if (!res.ok) { location.href = "index.html"; return null; }
      const me = await res.json().catch(() => null);
      if (!me || me.role !== "admin") { location.href = "dashboard.html"; return null; }
      adminName.textContent = me.username;
      return me;
    }

    async function loadUsers() {
      const res = await fetch("/api/admin?action=users&t=" + Date.now(), { credentials: "include", cache: "no-store" });
      if (!res.ok) return [];

      const data = await res.json().catch(() => ({ users: [] }));
      const list = (data.users || []).filter(Boolean).sort();
      users = list;

      // Dropdown füllen
      userFilter.innerHTML = `<option value="">Alle User</option>` + list.map(u => (
        `<option value="${u}">${u}</option>`
      )).join("");

      return list;
    }

    async function loadAllEmails() {
      setStatus("Lade Emails…");
      const limit = Number(limitSelect.value || 1000);

      const res = await fetch("/api/admin?action=all-emails&limit=" + limit + "&t=" + Date.now(), {
        credentials: "include",
        cache: "no-store"
      });

      if (!res.ok) {
        const t = await res.text().catch(() => "");
        setStatus(t || "Fehler beim Laden", false);
        tableWrap.innerHTML = `<div class="empty">Konnte Emails nicht laden.</div>`;
        totalPill.textContent = "Emails gesamt: 0";
        return;
      }

      const data = await res.json().catch(() => ({ emails: [], total: 0 }));
      allRows = (data.emails || []).map(x => ({
        username: String(x.username || "").toLowerCase(),
        email: String(x.email || "").toLowerCase(),
        ts: typeof x.ts === "number" ? x.ts : null
      }));

      totalPill.textContent = "Emails gesamt: " + (data.total ?? allRows.length);
      setStatus("OK", true);
      render();
    }

    function render() {
      const q = (qInput.value || "").trim().toLowerCase();
      const u = (userFilter.value || "").trim().toLowerCase();

      const rows = allRows.filter(r => {
        if (u && r.username !== u) return false;
        if (!q) return true;
        return r.username.includes(q) || r.email.includes(q);
      });

      if (!rows.length) {
        tableWrap.innerHTML = `<div class="empty">Keine Treffer.</div>`;
        return;
      }

      const html = `
        <table>
          <thead>
            <tr>
              <th>Zeit</th>
              <th>Email</th>
              <th>User</th>
              <th style="text-align:right;">Aktionen</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r, idx) => `
              <tr data-idx="${idx}">
                <td class="muted">${fmtTime(r.ts)}</td>
                <td class="mono">${escapeHtml(r.email)}</td>
                <td class="mono">${escapeHtml(r.username)}</td>
                <td style="text-align:right;">
                  <div class="actions">
                    <button class="btn btn-small btn-copy" data-copy="${escapeAttr(r.email)}">Copy</button>

                    <span class="inline">
                      <input class="euro" data-euro="${escapeAttr(r.username)}" inputmode="decimal" placeholder="€" />
                      <button class="btn btn-small btn-notify" data-notify="${escapeAttr(r.username)}">Notify</button>
                    </span>

                    <button class="btn btn-small btn-del" data-del="${escapeAttr(r.username)}|${escapeAttr(r.email)}">Löschen</button>
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      tableWrap.innerHTML = html;
      wireTableEvents();
    }

    function wireTableEvents() {
      // Copy
      tableWrap.querySelectorAll("[data-copy]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const email = btn.getAttribute("data-copy") || "";
          try {
            await navigator.clipboard.writeText(email);
            setStatus("Kopiert: " + email, true);
          } catch {
            setStatus("Copy nicht möglich (Browser).", false);
          }
        });
      });

      // Notify
      tableWrap.querySelectorAll("[data-notify]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const username = (btn.getAttribute("data-notify") || "").toLowerCase();
          const input = tableWrap.querySelector(`[data-euro="${CSS.escape(username)}"]`);
          const euro = input ? input.value.trim() : "";

          if (!euro) { setStatus("Bitte €-Betrag eingeben.", false); return; }

          const res = await fetch("/api/admin?action=notify&t=" + Date.now(), {
            method: "POST",
            credentials: "include",
            cache: "no-store",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, euro })
          });

          const text = await res.text().catch(() => "");
          if (!res.ok) { setStatus(text || "Notify fehlgeschlagen.", false); return; }

          setStatus("Nachricht gesendet an " + username + " ✅", true);
          if (input) input.value = "";
        });
      });

      // Delete Email
      tableWrap.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const v = btn.getAttribute("data-del") || "";
          const [username, email] = v.split("|").map(s => (s || "").toLowerCase());
          if (!username || !email) return;

          if (!confirm(`Email wirklich löschen?\n\n${email}\n(User: ${username})`)) return;

          const res = await fetch("/api/admin?action=emails&t=" + Date.now(), {
            method: "DELETE",
            credentials: "include",
            cache: "no-store",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, email })
          });

          const text = await res.text().catch(() => "");
          if (!res.ok) { setStatus(text || "Löschen fehlgeschlagen.", false); return; }

          // lokal entfernen
          allRows = allRows.filter(r => !(r.username === username && r.email === email));
          setStatus("Gelöscht ✅", true);
          render();
        });
      });
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s) {
      // minimal ok für data-attr
      return escapeHtml(s).replaceAll("`","&#096;");
    }

    // Controls
    qInput.addEventListener("input", () => render());
    userFilter.addEventListener("change", () => render());
    document.getElementById("refreshBtn").addEventListener("click", async () => {
      await loadAllEmails();
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/api/logout", { credentials: "include", cache: "no-store" });
      location.href = "index.html?loggedout=1";
    });

    // Init
    (async () => {
      const me = await requireAdmin();
      if (!me) return;

      await loadUsers();
      await loadAllEmails();
    })();
  </script>
</body>
</html>