<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>

  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(229,57,53,0.18), transparent 60%),
        radial-gradient(1200px 600px at 80% 0%, rgba(30,136,229,0.22), transparent 55%),
        linear-gradient(135deg, #f7f9fc, #eef3fb);
      color: #111;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.8);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .who {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #222;
      flex-wrap: wrap;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 13px;
      white-space: nowrap;
    }

    .adminTag {
      background: rgba(229,57,53,0.10);
      border: 1px solid rgba(229,57,53,0.22);
      color: #b71c1c;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .username { font-weight: 700; }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: white;
      transition: opacity 0.12s ease;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-back { background: #1e88e5; }
    .btn-logout { background: #e53935; }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 18px 46px;
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 20px 45px rgba(0,0,0,0.10);
      padding: 16px;
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #111;
    }

    .hint {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 13px;
      line-height: 1.45;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.16);
      background: white;
      font-size: 14px;
      outline: none;
    }

    select:focus {
      border-color: rgba(30,136,229,0.6);
      box-shadow: 0 0 0 4px rgba(30,136,229,0.12);
    }

    .btnRow {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn-load {
      background: linear-gradient(135deg, #1e88e5, #43cea2);
      font-weight: 700;
      border-radius: 12px;
      padding: 11px 14px;
      white-space: nowrap;
    }

    .btn-deleteUser {
      background: linear-gradient(135deg, #e53935, #b71c1c);
      font-weight: 800;
      border-radius: 12px;
      padding: 11px 14px;
      white-space: nowrap;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
      word-break: break-word;
      color: #b71c1c;
    }
    .status.ok { color: #1b5e20; }

    .headerLine {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .count {
      font-size: 13px;
      color: #444;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.06);
      padding: 7px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    ul { list-style: none; padding: 0; margin: 0; }

    li {
      padding: 12px;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      margin-bottom: 10px;
      background: rgba(0,0,0,0.02);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      word-break: break-word;
    }

    .email {
      color: #111;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 640px;
    }

    .meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .time {
      color: #666;
      font-size: 12px;
      white-space: nowrap;
    }

    .trash {
      border: none;
      cursor: pointer;
      background: rgba(229,57,53,0.10);
      border: 1px solid rgba(229,57,53,0.22);
      color: #b71c1c;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .trash:hover { opacity: 0.9; }
    .trash:disabled { opacity: 0.55; cursor: not-allowed; }

    .empty {
      padding: 12px;
      background: rgba(0,0,0,0.02);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      color: #444;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="who">
        <div class="pill">
          Angemeldet als <span class="username" id="adminName">Lade‚Ä¶</span>
        </div>
        <div class="pill adminTag">ADMIN</div>
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn btn-back" id="backBtn">Zur√ºck</button>
        <button class="btn btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="card">
      <h1>User ausw√§hlen</h1>
      <p class="hint">User ausw√§hlen ‚Üí Emails laden oder User komplett l√∂schen.</p>

      <div class="controls">
        <select id="userSelect" disabled>
          <option>Users laden‚Ä¶</option>
        </select>

        <div class="btnRow">
          <button class="btn btn-load" id="loadBtn" disabled>Laden</button>
          <button class="btn btn-deleteUser" id="deleteUserBtn" disabled>User l√∂schen</button>
        </div>
      </div>

      <div id="status" class="status"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="headerLine">
        <h1 id="listTitle">Emails</h1>
        <div class="count" id="countPill">Emails: 0</div>
      </div>
      <div id="listBox"></div>
    </div>
  </div>

  <script>
    const adminName = document.getElementById("adminName");
    const userSelect = document.getElementById("userSelect");
    const loadBtn = document.getElementById("loadBtn");
    const deleteUserBtn = document.getElementById("deleteUserBtn");
    const statusEl = document.getElementById("status");

    const listTitle = document.getElementById("listTitle");
    const countPill = document.getElementById("countPill");
    const listBox = document.getElementById("listBox");

    let currentUser = "";
    let loading = false;

    function setStatus(text, ok=false) {
      statusEl.className = "status" + (ok ? " ok" : "");
      statusEl.textContent = text || "";
    }

    function setLoading(isLoading) {
      loading = isLoading;
      userSelect.disabled = isLoading;
      loadBtn.disabled = isLoading || !userSelect.value;
      deleteUserBtn.disabled = isLoading || !userSelect.value;
    }

    function formatTime(ts) {
      if (!ts) return "";
      try { return new Date(ts).toLocaleString("de-DE"); } catch { return ""; }
    }

    function clearList() {
      listTitle.textContent = "Emails";
      countPill.textContent = "Emails: 0";
      listBox.innerHTML = `<div class="empty">Kein User geladen.</div>`;
    }

    async function requireAdmin() {
      const res = await fetch("/api/me", { credentials: "include" });
      if (!res.ok) {
        location.href = "index.html";
        return null;
      }

      const me = await res.json().catch(() => null);
      if (!me || me.role !== "admin") {
        location.href = "dashboard.html";
        return null;
      }

      adminName.textContent = me.username;
      return me;
    }

    async function loadUsers() {
      setStatus("Lade Users‚Ä¶");
      userSelect.innerHTML = `<option>Users laden‚Ä¶</option>`;
      userSelect.disabled = true;
      loadBtn.disabled = true;
      deleteUserBtn.disabled = true;

      const res = await fetch("/api/admin/users", { credentials: "include" });
      if (!res.ok) {
        setStatus("Konnte Users nicht laden.", false);
        userSelect.innerHTML = `<option>Fehler</option>`;
        return;
      }

      const data = await res.json().catch(() => null);
      const users = (data && data.users) ? data.users : [];

      if (!users.length) {
        setStatus("Keine Users gefunden.", true);
        userSelect.innerHTML = `<option value="">(leer)</option>`;
        return;
      }

      userSelect.innerHTML = `<option value="">‚Äî ausw√§hlen ‚Äî</option>` + users
        .map(u => `<option value="${u.replace(/"/g, "&quot;")}">${u}</option>`)
        .join("");

      userSelect.disabled = false;
      setStatus("Users geladen ‚úÖ", true);
    }

    function renderEmails(username, emails) {
      listTitle.textContent = "Emails von: " + username;
      countPill.textContent = "Emails: " + (emails?.length || 0);

      if (!emails || emails.length === 0) {
        listBox.innerHTML = `<div class="empty">Keine Emails gespeichert.</div>`;
        return;
      }

      const ul = document.createElement("ul");

      for (const item of emails) {
        const li = document.createElement("li");

        const emailSpan = document.createElement("span");
        emailSpan.className = "email";
        emailSpan.textContent = item.email;

        const meta = document.createElement("div");
        meta.className = "meta";

        const timeSpan = document.createElement("span");
        timeSpan.className = "time";
        timeSpan.textContent = formatTime(item.ts);

        const delBtn = document.createElement("button");
        delBtn.className = "trash";
        delBtn.textContent = "üóë";
        delBtn.title = "Email l√∂schen";
        delBtn.addEventListener("click", async () => {
          await deleteEmail(username, item.email, delBtn);
        });

        meta.appendChild(timeSpan);
        meta.appendChild(delBtn);

        li.appendChild(emailSpan);
        li.appendChild(meta);

        ul.appendChild(li);
      }

      listBox.innerHTML = "";
      listBox.appendChild(ul);
    }

    async function loadEmailsForUser(username) {
      if (!username) return;
      setLoading(true);
      setStatus("Lade Emails von " + username + "‚Ä¶");

      try {
        const res = await fetch("/api/admin/emails?username=" + encodeURIComponent(username), {
          credentials: "include"
        });

        if (!res.ok) {
          const text = await res.text();
          setStatus(text || "Konnte Emails nicht laden.", false);
          renderEmails(username, []);
          return;
        }

        const data = await res.json().catch(() => null);
        const emails = (data && data.emails) ? data.emails : [];

        currentUser = username;
        renderEmails(username, emails);
        setStatus("Emails geladen ‚úÖ", true);
      } catch {
        setStatus("Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    async function deleteEmail(username, email, btn) {
      if (loading) return;

      const ok = confirm(`Wirklich l√∂schen?\n\nUser: ${username}\nEmail: ${email}`);
      if (!ok) return;

      btn.disabled = true;
      setStatus("L√∂sche " + email + "‚Ä¶");

      try {
        const res = await fetch("/api/admin/emails", {
          method: "DELETE",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email })
        });

        const text = await res.text();

        if (!res.ok) {
          setStatus(text || "L√∂schen fehlgeschlagen.", false);
          btn.disabled = false;
          return;
        }

        setStatus("Gel√∂scht ‚úÖ", true);
        await loadEmailsForUser(username);
      } catch {
        setStatus("Server nicht erreichbar.", false);
        btn.disabled = false;
      }
    }

    async function deleteUser(username) {
      if (loading) return;
      if (!username) return;

      const ok = confirm(
        `USER KOMPLETT L√ñSCHEN?\n\nUser: ${username}\n\nDas l√∂scht Account + alle Emails.\nDiese Aktion ist endg√ºltig.`
      );
      if (!ok) return;

      setLoading(true);
      setStatus("L√∂sche User " + username + "‚Ä¶");

      try {
        const res = await fetch("/api/admin/user", {
          method: "DELETE",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });

        const text = await res.text();

        if (!res.ok) {
          setStatus(text || "User l√∂schen fehlgeschlagen.", false);
          return;
        }

        const data = JSON.parse(text);
        setStatus(`User gel√∂scht ‚úÖ (Emails gel√∂scht: ${data.deletedEmails ?? 0})`, true);

        // UI reset + users neu laden
        clearList();
        await loadUsers();
        userSelect.value = "";
        loadBtn.disabled = true;
        deleteUserBtn.disabled = true;

      } catch {
        setStatus("Server nicht erreichbar.", false);
      } finally {
        setLoading(false);
      }
    }

    userSelect.addEventListener("change", () => {
      loadBtn.disabled = !userSelect.value || loading;
      deleteUserBtn.disabled = !userSelect.value || loading;
    });

    loadBtn.addEventListener("click", () => {
      loadEmailsForUser(userSelect.value);
    });

    deleteUserBtn.addEventListener("click", () => {
      deleteUser(userSelect.value);
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      location.href = "dashboard.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/api/logout", { credentials: "include" });
      location.href = "index.html?loggedout=1";
    });

    (async () => {
      const me = await requireAdmin();
      if (!me) return;

      clearList();
      await loadUsers();
    })();
  </script>
</body>
</html>